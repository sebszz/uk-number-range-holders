<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UK Phone Number Lookup</title>
    <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Rubik', sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        input[type="text"] {
            width: 70%;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 4px;
        }
        #result a {
            color: #007bff;
            text-decoration: none;
        }
        #result a:hover {
            text-decoration: underline;
        }
        h4 {
            margin-bottom: 5px;
        }
        p{
            margin-top:0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>UK Phone Number Information</h1>
        <p>Enter a UK phone number (e.g., 01603112345 or +441603112345):</p>
        <input type="text" id="phoneInput" placeholder="Enter phone number">
        <button onclick="getPhoneInfo()">Get Info</button>
        <div id="result"></div>
    </div>

    <script>
        let providers = {};
        let areaMap = {};

        function getRelativeTime(updateDateStr) {
            const [day, month, year] = updateDateStr.split('/').map(Number);
            const updateDate = new Date(year, month - 1, day);
            const now = new Date();
            const diffInMs = now - updateDate;
            if (diffInMs < 0) return 'in the future';
            const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));
            if (diffInDays === 0) return 'today';
            if (diffInDays < 30) return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
            const months = Math.floor(diffInDays / 30.4375);
            if (months < 12) {
                const remainingDays = Math.floor(diffInDays % 30.4375);
                if (remainingDays === 0) {
                    return `${months} month${months > 1 ? 's' : ''} ago`;
                }
                return `${months} month${months > 1 ? 's' : ''} and ${remainingDays} day${remainingDays > 1 ? 's' : ''} ago`;
            }
            const years = Math.floor(diffInDays / 365.25);
            const remainingDaysAfterYears = diffInDays % 365.25;
            const remMonths = Math.floor(remainingDaysAfterYears / 30.4375);
            const remDays = Math.floor(remainingDaysAfterYears % 30.4375);
            let str = `${years} year${years > 1 ? 's' : ''}`;
            if (remMonths > 0) {
                str += `, ${remMonths} month${remMonths > 1 ? 's' : ''}`;
            }
            if (remDays > 0) {
                if (remMonths > 0) {
                    str += ' and ';
                } else {
                    str += ', ';
                }
                str += `${remDays} day${remDays > 1 ? 's' : ''}`;
            }
            str += ' ago';
            return str;
        }

        async function loadJsonLocalOrRemote(localPath, remoteUrl) {
            const filename = localPath.split('/').pop();

            if (location.protocol === 'file:') {
                console.log(`Running from file://, using remote ${filename}`);
                const response = await fetch(remoteUrl);
                if (!response.ok) {
                    throw new Error('Remote fetch failed');
                }
                return await response.json();
            }

            try {
                const response = await fetch(localPath);
                if (!response.ok) {
                    throw new Error('Local file not found');
                }
                console.log(`Using local ${filename}`);
                return await response.json();
            } catch (e) {
                console.log(`Local ${filename} not found, using remote`);
                const response = await fetch(remoteUrl);
                if (!response.ok) {
                    throw new Error('Remote fetch failed');
                }
                return await response.json();
            }
        }

        async function getPhoneInfo() {
            const input = document.getElementById('phoneInput');
            const resultDiv = document.getElementById('result');
            const numStr = input.value.replace(/\D/g, ''); // Extract digits only

            if (numStr.length < 10) {
                resultDiv.textContent = 'Please enter a valid UK phone number.';
                return;
            }

            let normalized;
            if (numStr.startsWith('44')) {
                normalized = numStr;
            } else if (numStr.startsWith('0')) {
                normalized = '44' + numStr.substring(1);
            } else {
                resultDiv.textContent = 'Invalid UK phone number format.';
                return;
            }

            if (!normalized.startsWith('44')) {
                resultDiv.textContent = 'Invalid UK phone number.';
                return;
            }

            const displayNum = '0' + normalized.substring(2);

            // Fetch providers if not loaded
            if (Object.keys(providers).length === 0) {
                try {
                    providers = await loadJsonLocalOrRemote('./numberProviders.json', 'https://raw.githubusercontent.com/sebszz/uk-number-range-holders/refs/heads/main/numberProviders.json');
                } catch (e) {
                    resultDiv.textContent = 'Error fetching provider data.';
                    return;
                }
            }

            // Fetch area codes if not loaded
            if (Object.keys(areaMap).length === 0) {
                try {
                    const areaData = await loadJsonLocalOrRemote('./areaCodes.json', 'https://raw.githubusercontent.com/sebszz/uk-number-range-holders/refs/heads/main/areaCodes.json');
                    areaMap = {};
                    for (let k in areaData) {
                        areaMap[k.substring(1)] = areaData[k]; // Remove '+' to get '442890'
                    }
                } catch (e) {
                    resultDiv.textContent = 'Error fetching area code data.';
                    return;
                }
            }

            // Find best provider match (longest prefix)
            let bestProviderKey = '';
            let bestPLength = 0;
            for (let key in providers) {
                if (normalized.startsWith(key) && key.length > bestPLength) {
                    bestPLength = key.length;
                    bestProviderKey = key;
                }
            }
            const providerName = bestProviderKey ? providers[bestProviderKey] : 'Unknown';
            const rangeStr = bestProviderKey ? '0' + bestProviderKey.substring(2) + 'XXXXX' : 'Unknown';

            // Determine city/location
            let cityName;
            if (normalized.startsWith('447')) {
                cityName = 'UK mobile number, so no location is assigned';
            } else {
                // Find best area match (longest prefix)
                let bestAreaKey = '';
                let bestALength = 0;
                for (let key in areaMap) {
                    if (normalized.startsWith(key) && key.length > bestALength) {
                        bestALength = key.length;
                        bestAreaKey = key;
                    }
                }
                cityName = bestAreaKey ? areaMap[bestAreaKey] : 'Unknown';
            }

            // Construct location sentence
            const locationSentence = cityName.startsWith('UK mobile') 
                ? `This is a ${cityName}.` 
                : `This number is also a ${cityName} area-code number.`;

            // Construct provider part conditionally
            let providerPart = `Number range holder is ${providerName}.`;
            if (providerName !== 'Unknown') {
                providerPart += ` They own the range ${rangeStr}.`;
            }

            // Date and relative time
            const updateDateStr = '15/10/2025';
            const relativeTime = getRelativeTime(updateDateStr);

            // Construct result with hyperlink
            const result = `${providerPart} ${locationSentence} <br/><br/>Please note, the last update of number range holders has been updated on ${updateDateStr} (${relativeTime}). For the most up to date results go to <a href="https://www.ofcom.org.uk/phones-and-broadband/phone-numbers/numbering-data" target="_blank">Ofcom website</a>. <h4>Number is ported?</h4>It's possible that ${displayNum} may have been ported to another provider. Number porting information is not publically available.`;

            // Additional link
            const phonelyLink = `https://www.phonely.co.uk/who-called-me/${displayNum}`;
            const additionalLink = `<h4>Check for reports</h4><p><a href="${phonelyLink}" target="_blank">Click here</a> to check if there are any online reports about calls from ${displayNum}.</p>`;

            resultDiv.innerHTML = result + additionalLink;
        }
    </script>
</body>
</html>